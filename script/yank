#!/bin/sh
set -eu

read_input() {
  cat "$@"
}

is_command_available() {
  command -v "$1" >/dev/null 2>&1
}

is_tmux() {
  [ -n "${TMUX:-}" ]
}

is_screen() {
  case "${TERM:-}" in
    screen*) return 0 ;;
    *) return 1 ;;
  esac
}

osc52_copy() {
  text=$1
  max=74994
  length=$(printf "%s" "$text" | wc -c)

  if [ "$length" -gt "$max" ]; then
    echo "Error: input exceeds OSC 52 limit by $(( length - max )) bytes" >&2
    return 1
  fi

  payload=$(printf "%s" "$text" | head -c "$max" | base64 | tr -d '\r\n')

  esc="$(printf '\033]52;c;%s\a' "$payload")"
  if is_tmux || is_screen; then
    esc="$(printf '\033Ptmux;\033%s\033\\' "$esc")"
  fi

  printf "%s" "$esc"
}

tmux_copy() {
  text=$1
  if is_tmux && is_command_available tmux; then
    printf "%s" "$text" | tmux load-buffer -
  fi
}

emulate_xsel() {
  mode=$1
  selection=$2
  store="${TMPDIR:-/tmp}/.fake_xsel_${selection}"

  case "$mode" in
    input)
      data=$(cat)
      osc52_copy "$data"
      tmux_copy "$data"
      printf "%s" "$data" >"$store"
      ;;
    output)
      cat "$store" 2>/dev/null || true
      ;;
    clear)
      : >"$store"
      ;;
    append)
      data=$(cat)
      printf "%s" "$data" >>"$store"
      ;;
    *)
      echo "Usage: $0 [--input|--output|--clear|--append] [--primary|--clipboard]" >&2
      exit 1
      ;;
  esac
}

main() {
  mode=input
  selection=primary

  while [ $# -gt 0 ]; do
    case "$1" in
      --input|-i) mode=input ;;
      --output|-o) mode=output ;;
      --primary|-p) selection=primary ;;
      --clipboard|-b) selection=clipboard ;;
      --clear) mode=clear ;;
      --append|-a) mode=append ;;
    esac
    shift
  done

  emulate_xsel "$mode" "$selection"
}

main "$@"
