#!/bin/sh
set -eu

read_input() {
  cat "$@"
}

is_command_available() {
  command -v "$1" >/dev/null 2>&1
}

is_tmux() {
  [ -n "${TMUX:-}" ]
}

is_screen() {
  case "${TERM:-}" in
    screen*) return 0 ;;
    *) return 1 ;;
  esac
}

osc52_copy() {
  text=$1
  max=74994
  length=$(printf "%s" "$text" | wc -c)

  if [ "$length" -gt "$max" ]; then
    echo "Error: input exceeds OSC 52 limit by $(( length - max )) bytes" >&2
    return 1
  fi

  payload=$(printf "%s" "$text" | head -c "$max" | base64 | tr -d '\r\n')

  esc="$(printf '\033]52;c;%s\a' "$payload")"
  if is_tmux || is_screen; then
    esc="$(printf '\033Ptmux;\033%s\033\\' "$esc")"
  fi

  printf "%s" "$esc"
}

tmux_copy() {
  text=$1
  if is_tmux && is_command_available tmux; then
    printf "%s" "$text" | tmux load-buffer -
  fi
}

main() {
  input=$(read_input "$@")

  osc52_copy "$input"
  tmux_copy "$input"
}

main "$@"
