name: Build Container Images

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

env:
  REGISTRY: ghcr.io
  ORG_NAME: ${{ github.repository_owner }}
  IMAGE_NAME: ${{ github.event.repository.name }}

jobs:
  # 1. PREP JOB: Reads config.json and generates dynamic matrix
  prep-matrix:
    runs-on: ubuntu-latest
    outputs:
      manifest-variants: ${{ steps.read-config.outputs.manifest-variants }}
      build-matrix: ${{ steps.read-config.outputs.build-matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read config and generate build matrix
        id: read-config
        run: |
          # --- Configuration ---
          CONFIG_FILE=".github/workflows/config.json"

          if [ ! -f $CONFIG_FILE ]; then
            echo "Error: $CONFIG_FILE not found."
            exit 1
          fi

          # Read config.json
          FULL_CONFIG=$(cat $CONFIG_FILE)

          # --- Dynamic Generation using jq ---

          # 1. Generate BUILD_MATRIX (item-level)
          # We iterate over .variants and .archs directly from the input JSON
          BUILD_MATRIX=$(echo "$FULL_CONFIG" | jq -c -r '
            [
              .variants[] as $variant |
              .archs[] as $arch |
              {
                "name": [$variant.name, $arch.name] | join("-"),
                "dockerfile": $variant.dockerfile,
                "runner": $arch.runner,
              }
            ]
          ')

          # 2. Generate MANIFEST_VARIANTS (variant-level)
          # Creates the list of suffixes needed for the final merge
          MANIFEST_VARIANTS=$(echo "$FULL_CONFIG" | jq -c -r '
            . as $root |
            [
              .variants[] as $variant|
              {
                "name": $variant.name,
                "arch": [$root.archs[] | .name],
              }
            ]
          ')

          # --- Set Outputs (Using Safe EOF Delimiter) ---
          {
            echo "manifest-variants<<EOF"
            echo "$MANIFEST_VARIANTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "build-matrix<<EOF"
            echo "$BUILD_MATRIX"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  # 2. BUILD JOB: Builds individual arch images
  build:
    needs: [prep-matrix]
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJson(needs.prep-matrix.outputs.build-matrix) }}

    name: Build ${{ matrix.item.name }}
    runs-on: ${{ matrix.item.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORG_NAME }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tags include the variant suffix and the architecture
            type=semver,pattern={{version}},suffix=-${{ matrix.item.name }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: ${{ matrix.item.dockerfile }}

  merge-manifests:
    needs: [prep-matrix, build]
    permissions:
      packages: write
      contents: read

    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJson(needs.prep-matrix.outputs.manifest-variants) }}

    name: Merge Manifest ${{ matrix.variant.name }}
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Meta (Final Tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORG_NAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},suffix=-${{ matrix.variant.name }}
            type=semver,pattern={{major}},suffix=-${{ matrix.variant.name }}
            type=semver,pattern={{major}}.{{minor}},suffix=-${{ matrix.variant.name }}
            type=raw,value=${{ matrix.variant.name }}
            type=raw,value=latest,enable=${{ matrix.variant.name == 'base' }}

      - name: Create and Push Manifest List
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          REPO="${{ env.REGISTRY }}/${{ env.ORG_NAME }}/${{ env.IMAGE_NAME }}"

          ARCH_STRING="${{ join(matrix.variant.arch, ' ') }}"
          IMAGES=""
          for ARCH in $ARCH_STRING; do
            IMAGES+="$REPO:$VERSION-$ARCH "
          done

          TARGET_TAGS=$(echo "${{ steps.meta.outputs.tags }}" | awk '{print "-t " $0}' | xargs)

          docker buildx imagetools create $TARGET_TAGS $IMAGES
